---
description: Regras imutaveis da calculadora salarial (arquitetura data-driven e proibicao de hardcode)
globs:
  - "src/**/*.ts"
  - "src/**/*.tsx"
  - "supabase/**/*.sql"
alwaysApply: true
---

# Rules - Calculadora Data-Driven

## 1) Fonte de verdade
- Toda regra de calculo deve respeitar a hierarquia:
  - `global_config`: regras universais (IR, PSS, teto RGPS)
  - `power_config`: regras de carreira (bases, beneficios, cronogramas, diarias)
  - `org_config`: overrides especificos do orgao
- A UI nao pode recalcular tributos por conta propria fora do motor oficial.

## 2) Proibicoes
- Proibido hardcode de aliquota, faixa, deducao, teto, percentual legal e regra por orgao.
- Proibido criar card fixo para nova rubrica de holerite.
- Proibido voltar a depender de fonte legada fora do fluxo de configuracao oficial.

## 3) Motor de calculo
- O calculo oficial deve ficar no motor (`JmuService` e modulos).
- O adaptador de estado deve enviar ao motor todos os campos necessarios.
- Rubricas manuais devem ser tratadas genericamente, sem condicionais por nome.

## 4) Rubricas dinamicas
- Qualquer rubrica manual deve suportar:
  - tipo (`C`/`D`)
  - descricao
  - valor
  - incidencia em base de IR (`incideIR`)
  - incidencia em base de PSS (`incidePSS`)

## 5) Qualidade minima
- Mudanca de calculo exige build limpo.
- Mudanca de regra deve manter rastreabilidade (documento/seed/migracao).
- Regras de diarias devem existir em `power_config.config_key = dailies_rules`.
- Regras gerais de formula devem existir em `power_config.config_key = payroll_rules`.
- Catalogo de carreira deve existir em `power_config.config_key = career_catalog`.
- Periodos de referencia/reajuste devem existir em `power_config.config_key = adjustment_schedule`.

## 6) Schema minimo de diarias
- `dailies_rules.rates` deve definir valores por cargo e/ou agrupamento.
- `dailies_rules.embarkation_additional` deve definir `completo` e `metade`.
- `dailies_rules.derived_from_minister` (quando habilitado) deve permitir recalculo automatico:
  - `enabled`
  - `minister_per_diem`
  - `rates_percentages` (ex.: `tecnico`, `analista`, `cj`)
  - `embarkation_percentage_full`
  - `embarkation_percentage_half` (opcional)
- `dailies_rules.external_gloss` deve definir percentuais de `hospedagem`, `alimentacao`, `transporte`.
- `dailies_rules.ldo_cap` deve definir `enabled` e `per_diem_limit`.
- `dailies_rules.discount_rules` deve definir:
  - `food_divisor`
  - `transport_divisor`
  - `exclude_weekends_and_holidays`
  - `holidays` (lista `YYYY-MM-DD`)
